<!DOCTYPE html>
<html lang='en'>
<head>
<script src="/games/divinestar/babylon/babylon.js"></script>
<script src="/games/divinestar/js/cannon.js"></script>
<script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
<script src="/games/divinestar/babylon/loaders/babylonjs.loaders.min.js"></script>
<script src="/games/divinestar/babylon/materialsLibrary/babylonjs.materials.min.js"></script>
<script src="/games/divinestar/babylon/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
<script src="/games/divinestar/babylon/gui/babylon.gui.min.js"></script>
<script src="/games/divinestar/babylon/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
<script src="/games/divinestar/babylon/serializers/babylonjs.serializers.min.js"></script>
<script src="/games/divinestar/babylon//nodeEditor/babylon.nodeEditor.js"></script>
<style>
        html, body {
            overflow: hidden;
            width   : 100%;
            height  : 100%;
            margin  : 0;
            padding : 0;
        }

        #renderCanvas {
            width   : 100%;
            height  : 100%;
    
            touch-action: none;
        }
        #menu {
        	position: absolute;
        	left: 10px;
        	top: 10px;
        	display: none;
        	width: 500px;
        	height: 500px;
        	padding-left: 20px;
        	background-color: rgb(0,0,0,.5);
        }
        #menu h1 {
        	color: green;
        }
        #menu p {
        	color: white;
        }
        .box {
        	height:50px; width:50px;
        	border:2px solid black;
        }
    </style>
</head>
<body>
	<div id='menu'>
		<h1>Hello</h1>
		<p>This is some menu text.</p>
		<div class='box'>
		</div>
	</div>
    <canvas id="renderCanvas"></canvas>
    <script type='module'>

import {PlayerObject} from './js/PlayerObject.js'
import {PlayerSesnor} from './js/PlayerSesnor.js'



var createPhysicsImpostor = function(scene, entity, impostor, options, reparent) {
    if (entity == null) return;
    entity.checkCollisions = false;
    const parent = entity.parent;
    if (reparent === true) entity.parent = null;
    entity.physicsImpostor = new BABYLON.PhysicsImpostor(entity, impostor, options, scene);
    if (reparent === true) entity.parent = parent;
};



        window.addEventListener('DOMContentLoaded', function(){
            // get the canvas DOM element
            var canvas = document.getElementById('renderCanvas');

            // load the 3D engine
            var engine = new BABYLON.Engine(canvas, true);



var createScene = function () {
    // Setup the scene
    var scene = new BABYLON.Scene(engine);
  	scene.debugLayer.show();

    var gravityVector = new BABYLON.Vector3(0,-9.8, 0);
	var physicsPlugin = new BABYLON.CannonJSPlugin();
	scene.enablePhysics(gravityVector, physicsPlugin);
    scene.collisionsEnabled = true;

	
/*
    var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 5, -10), scene);
    camera.attachControl(canvas, true);
    camera.setTarget(new BABYLON.Vector3(0, 0, 0));
	
 camera.attachControl(canvas, true);
*/


    var camera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0, 10, -10), scene);
    camera.radius = 1; // how far from the object to follow
    camera.heightOffset = 3; // how high above the object to place the camera

    camera.cameraAcceleration = 0; // how fast to move
    camera.maxCameraSpeed = 20; // speed limit
   

  
    scene.activeCamera = camera;

     camera.attachControl(canvas, false);

	var distance = 10;	
	var aspect = scene.getEngine().getRenderingCanvasClientRect().height / scene.getEngine().getRenderingCanvasClientRect().width; 
	
    camera.attachControl(canvas, false);
     var light0 = new BABYLON.PointLight("Omni0", new BABYLON.Vector3(3, .5, 1.5), scene);
    var light1 = new BABYLON.PointLight("Omni1", new BABYLON.Vector3(0, .5, 1.5), scene);
    var light2 = new BABYLON.PointLight("Omni2", new BABYLON.Vector3(5.5, 1, 0), scene);
    light0.diffuse = new BABYLON.Color3(1, 0, 1);
    light0.specular = new BABYLON.Color3(1, 0, 1);
    light0.intensity = 2;
    light1.intensity = 10;
    light2.intensity = 5;
    light1.diffuse = new BABYLON.Color3(1, 0, 0);
    light1.specular = new BABYLON.Color3(1, 0, 0);

    light2.diffuse = new BABYLON.Color3(0, 0, 1);
    light2.specular = new BABYLON.Color3(0, 0, 1);

    var shadowGenerator = new BABYLON.ShadowGenerator(1024, light0);
	shadowGenerator.useExponentialShadowMap = true;

    var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 1, 0), scene);
    //engine.enableOfflineSuppourt = false;

 


    BABYLON.SceneLoader.ImportMesh("","./assets/", "level.babylon", scene, function (meshes,particles,skeltons) {
 

  		meshes.forEach(function(mesh,index){

				mesh.checkCollisions = true;

  		if(mesh.name != 'player'){
  		mesh.physicsImpostor = new BABYLON.PhysicsImpostor(mesh, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0.9 }, scene);
  	
  		}

  		


  		});


        
    });


 


var cylinder = BABYLON.MeshBuilder.CreateCylinder("playerhitbox", {height: .5, diameter: .2}, scene);
    cylinder.position = new BABYLON.Vector3(1, .5, 0);
var playersesnor =  BABYLON.MeshBuilder.CreateSphere("sesnor", { diameter: .3}, scene);
    playersesnor.position = new BABYLON.Vector3(0, .5, .1);
var cylinder2 = BABYLON.MeshBuilder.CreateCylinder("test", {height: .8, diameter: .5}, scene);
    cylinder2.position = new BABYLON.Vector3(.5, 1, 0);
    scene.test = cylinder2;
var player = new PlayerObject();
//player.setCameraOnPlayer(false);
Promise.all([
      BABYLON.SceneLoader.ImportMesh(null,"./assets/players/starman/", "starmangoodtest.glb", scene, function (meshes,particles,skeltons)  {
 		player.setScene(scene);
 		player.setCamera(camera)


 		player.setModel(meshes);
console.log(meshes)


	meshes.forEach(function(mesh,index){

	console.log(mesh.name);
 	
	if(mesh.name == '__root__') {
	
	mesh.parent = cylinder;
	playersesnor.parent = cylinder;
 cylinder.physicsImpostor =  new BABYLON.PhysicsImpostor(cylinder, BABYLON.PhysicsImpostor.CylinderImpostor, { damping: 100, friction: 5, mass: 10, restitution: 0,  }, scene);
  
  	cylinder.isVisible = false;
   		//mesh.position.y = .5;
		//mesh.position.x = 5;
	}

 		});




 player.setHitBox(cylinder);

	player.setMovementMode('keyboard');

    }),

]).then(() => {

});



    var inputMap ={};
    scene.actionManager = new BABYLON.ActionManager(scene);
    scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, function (evt) {								
        inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
    }));
    scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, function (evt) {								
        inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
    }));

    player.addcontrols(inputMap);


    // Game/Render loop
    scene.onBeforeRenderObservable.add(()=>{

	
    	player.update();
     
       

    })



    return scene;

};


            // call the createScene function
            var scene = createScene();

            // run the render loop
            engine.runRenderLoop(function(){
                scene.render();
            });

            // the canvas/window resize event handler
            window.addEventListener('resize', function(){
                engine.resize();
            });
        });
    </script>
</body>
</html>